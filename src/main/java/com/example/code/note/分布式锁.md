### 分布式id

[九种分布式id](https://zhuanlan.zhihu.com/p/107939861)

[号段和雪花](https://zhuanlan.zhihu.com/p/370207654)

[leaf](https://tech.meituan.com/2017/04/21/mt-leaf.html)

号段遇到单点故障-集群解决，遇到重启重复消费，可以加version字段实现乐观锁且每次去数据库拿

雪花可能遇到时钟回拨 先去zk存持久顺序节点，后去拿当前时间，查看当前时间是否大于之前记录的时间，大于则正常，小于说明出现了回拨，回滚操作，再去拿各个节点计算出来的平均时间是否大于之前记录的时间，大于则正常，小于就回滚

### 分布式锁

redis分布式锁

redis集群保证高可用性

客户端1和客户端2同时获取一个锁，因为不是强一致性，可能都获得同一把锁，——>RedLock算法

fullGC带来的锁超时

必须获取5个节点的3个节点以上，大家都获取了1或2个锁，结果谁也不能获取到锁，这个问题，redis作者借鉴了raft算法的精髓，冲突后随机时间开始

![image-20210818232425611](/Users/yicheng/Library/Application Support/typora-user-images/image-20210818232425611.png)

zk分布式锁

自身特性：1.监听者提供事件通知功能 2.znode节点的不可重复特性

临时顺序节点，使用子节点，每当有线程请求锁的时候，就在锁的节点下创建一个子节点，子节点类型必须维护一个顺序，默认总是最小的子节点对应的线程获取锁，释放锁的时候删除对应的子节点便可

为了防止zk挂掉，用zk集群