### 分布式事务

#### 前置知识

* ACID

A原子性：所有操作要么全部成功，要么全部失败，undolog

C 一致性： 执行前和执行之后保证数据一致性

I 隔离型：保证不同事务发生时修改的隔离

D 持久性： 一旦提交，永久保存 两阶段提交

* **CAP**

**C（Consistency）**：一致性。服务A、B、C三个节点都存储了用户数据，三个节点的数据都需要保持同一时刻数据一致性，对于客户端来说，读操作能够返回最新的写操作，每个节点都是这样，就是强一致性

**A（Availability）**：可用性。服务A、B、C三个节点，其中一个节点如果宕机了，不能影响整个集群对外提供服务。

**P（Partition Tolerance）**：分区容错性就是允许系统通过网络协同工作，在出现网络分区后，出现网络故障，但是集群仍然可以提供正常工作



> 大多数是AP理论



* **BASE**

BA基本可用：当出现故障的时候，允许出现部分不可用，但是核心必须可用

S软状态 ：允许系统出现中间状态，就是不一致的读取

E最终一致性：但是经过一段时间保证数据最终完全一致

#### 全局事务/两阶段提交(2PC)

第一阶段：事务管理器通知参与事务的服务先进行自己的预提交操作，所有参与者都将自己的事务进行预提交，并将能否成功的信息反馈给事务管理器

第二阶段：事务管理器发现可以一起提交，通知准备就绪 ，让服务各自去各自的资源管理器真正修改资源，统一提交或者回滚

优点： 尽量保证了数据的强一致，实现成本较低，对于MySQL是从5.5开始支持。

缺点：1、单点问题：第一阶段之后，事务管理器宕机，资源管理器就会一直阻塞，导致数据库无法使用。

2、同步阻塞：如果没到第二阶段，资源管理器只能一直同步阻塞，提交才能释放资源，延迟了提交事件，加长了资源阻塞事件，不适合高并发的场景

3、数据不一致：如果执行到第二阶段，有可能分布式系统长期运行导致网络问题，部分参与者接收到 **commit** 消息，部分没有收到，那也只有部分参与者提交了事务，依然会导致数据不一致问题

#### 三阶段提交

